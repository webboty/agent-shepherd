# Design Document: Directory Structure Refactoring

## Architectural Reasoning

### Current State
Agent Shepherd currently scatters files across the project root and src/, with built CLI in dist/cli/index.js and configs in .agent-shepherd/. This violates tool conventions and clutters user projects.

### Proposed Architecture
Move all tool files into `.agent-shepherd/` directory with substructure:
- config/ for user configs
- bin/ for CLI binary
- src/ for source code
- schemas/ for validation
- tests/ for tests
- docs/ for docs

Development repo becomes the canonical structure, installation copies it.

### Detailed File Structures

#### Current Structure Analysis
**Root Level Files (Development Repository)**
```
agent-shepherd-repo/
â”œâ”€â”€ README.md                    # User manual and documentation
â”œâ”€â”€ package.json                 # Node.js package definition with dependencies
â”œâ”€â”€ bun.lock                     # Bun dependency lock file
â”œâ”€â”€ bunfig.toml                  # Bun configuration
â”œâ”€â”€ eslint.config.js             # ESLint configuration with TypeScript support
â”œâ”€â”€ dist/cli/index.js           # BUILT CLI binary (generated by build)
â””â”€â”€ .agent-shepherd/            # CURRENT runtime config (created by ashep init)
    â”œâ”€â”€ config.yaml
    â”œâ”€â”€ policies.yaml
    â””â”€â”€ agents.yaml
```

**Source Code (src/)**
```
src/
â”œâ”€â”€ cli/index.ts                 # CLI entry point with all commands (worker, monitor, work, ui, init, install, sync-agents)
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ agent-registry.ts        # Agent capability registry and selection logic
â”‚   â”œâ”€â”€ beads.ts                 # Beads issue tracking integration (getIssue, updateIssue)
â”‚   â”œâ”€â”€ config.ts                # Configuration loading and default value application
â”‚   â”œâ”€â”€ config-validator.ts      # JSON Schema validation for all config files
â”‚   â”œâ”€â”€ logging.ts               # Dual-storage logging (JSONL + SQLite)
â”‚   â”œâ”€â”€ monitor-engine.ts        # Supervision, stall detection, timeout handling
â”‚   â”œâ”€â”€ opencode.ts              # OpenCode AI agent integration via CLI
â”‚   â”œâ”€â”€ policy.ts                # Workflow policy engine and phase management
â”‚   â””â”€â”€ worker-engine.ts         # Issue processing and orchestration engine
â””â”€â”€ ui/
    â”œâ”€â”€ ui-server.ts             # Express server with REST API and ReactFlow serving
    â””â”€â”€ AgentShepherdFlow.tsx    # ReactFlow visualization component
```

**Supporting Files**
```
â”œâ”€â”€ schemas/                     # JSON Schema validation files
â”‚   â”œâ”€â”€ config.schema.json       # Main configuration validation
â”‚   â”œâ”€â”€ policies.schema.json     # Workflow policy validation
â”‚   â”œâ”€â”€ agents.schema.json       # Agent registry validation
â”‚   â””â”€â”€ run-outcome.schema.json  # Execution result validation
â”œâ”€â”€ tests/                       # Complete test suite
â”‚   â”œâ”€â”€ basic.test.ts            # Framework validation
â”‚   â”œâ”€â”€ config-validator.test.ts # Configuration validation tests
â”‚   â”œâ”€â”€ policy-engine.test.ts    # Policy engine tests
â”‚   â”œâ”€â”€ agent-registry.test.ts   # Agent registry tests
â”‚   â”œâ”€â”€ e2e.test.ts              # End-to-end workflow tests
â”‚   â””â”€â”€ cli-integration.test.ts  # CLI command integration tests
â””â”€â”€ docs/
    â”œâ”€â”€ architecture.md          # Technical architecture deep-dive
    â””â”€â”€ cli-reference.md          # Complete CLI command reference
```

#### Target Structure
**New .agent-shepherd/ Directory Structure**
```
.agent-shepherd/
â”œâ”€â”€ config/                      # ğŸ—‚ï¸ User configuration files
â”‚   â”œâ”€â”€ config.yaml              # Main configuration (worker/monitor/UI settings)
â”‚   â”œâ”€â”€ policies.yaml            # Workflow policy definitions
â”‚   â””â”€â”€ agents.yaml              # Agent registry and capabilities
â”œâ”€â”€ bin/                         # ğŸ› ï¸ CLI binary and executables
â”‚   â””â”€â”€ ashep                    # Local CLI entry point
â”œâ”€â”€ src/                         # ğŸ“ Core source code (for development/debugging)
â”‚   â”œâ”€â”€ cli/index.ts
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ agent-registry.ts
â”‚   â”‚   â”œâ”€â”€ beads.ts
â”‚   â”‚   â”œâ”€â”€ config.ts
â”‚   â”‚   â”œâ”€â”€ config-validator.ts
â”‚   â”‚   â”œâ”€â”€ logging.ts
â”‚   â”‚   â”œâ”€â”€ monitor-engine.ts
â”‚   â”‚   â”œâ”€â”€ opencode.ts
â”‚   â”‚   â”œâ”€â”€ policy.ts
â”‚   â”‚   â””â”€â”€ worker-engine.ts
â”‚   â””â”€â”€ ui/
â”‚       â”œâ”€â”€ ui-server.ts
â”‚       â””â”€â”€ AgentShepherdFlow.tsx
â”œâ”€â”€ schemas/                     # âœ… JSON validation schemas
â”‚   â”œâ”€â”€ config.schema.json
â”‚   â”œâ”€â”€ policies.schema.json
â”‚   â”œâ”€â”€ agents.schema.json
â”‚   â””â”€â”€ run-outcome.schema.json
â”œâ”€â”€ tests/                       # ğŸ§ª Test suite
â”‚   â”œâ”€â”€ basic.test.ts
â”‚   â”œâ”€â”€ config-validator.test.ts
â”‚   â”œâ”€â”€ policy-engine.test.ts
â”‚   â”œâ”€â”€ agent-registry.test.ts
â”‚   â”œâ”€â”€ e2e.test.ts
â”‚   â””â”€â”€ cli-integration.test.ts
â”œâ”€â”€ docs/                        # ğŸ“– Documentation
â”‚   â”œâ”€â”€ architecture.md
â”‚   â””â”€â”€ cli-reference.md
â”œâ”€â”€ README.md                    # ğŸ“‹ Tool documentation
â””â”€â”€ package.json                 # ğŸ“¦ Tool metadata and scripts
```

**Project Root (After Refactoring)**
```
project/                         # User's project
â”œâ”€â”€ .agent-shepherd/            # ğŸ  Agent Shepherd tool directory
â”‚   â””â”€â”€ [all files above]
â”œâ”€â”€ .opencode/                  # Other tools
â”œâ”€â”€ .beads/
â”œâ”€â”€ .git/
â””â”€â”€ src/                        # User's application code
```

#### File Inventory (Complete List)
**Source Files to Move:**
- src/cli/index.ts
- src/core/agent-registry.ts
- src/core/beads.ts
- src/core/config.ts
- src/core/config-validator.ts
- src/core/logging.ts
- src/core/monitor-engine.ts
- src/core/opencode.ts
- src/core/policy.ts
- src/core/worker-engine.ts
- src/ui/ui-server.ts
- src/ui/AgentShepherdFlow.tsx

**Schema Files to Move:**
- schemas/config.schema.json
- schemas/policies.schema.json
- schemas/agents.schema.json
- schemas/run-outcome.schema.json

**Test Files to Move:**
- tests/basic.test.ts
- tests/config-validator.test.ts
- tests/policy-engine.test.ts
- tests/agent-registry.test.ts
- tests/e2e.test.ts
- tests/cli-integration.test.ts

**Documentation Files to Move:**
- docs/architecture.md
- docs/cli-reference.md
- README.md

**Configuration Files to Move:**
- Default config.yaml, policies.yaml, agents.yaml (from development repo)

**Build/Dev Files:**
- package.json (updated bin field)
- eslint.config.js
- bunfig.toml

### Benefits of config/ Subdirectory Approach
Using a dedicated `config/` subdirectory within `.agent-shepherd/` provides several advantages compared to placing configuration files directly in the root:

- **Better Organization**: Separates configuration files from other tool components (binaries, source code, schemas), making the directory structure more intuitive and easier to navigate. Users can quickly identify and modify configuration without sifting through unrelated files.

- **Improved User Experience**: A clear config/ location reduces confusion about where to place or find settings. This follows common patterns in developer tools, creating a familiar experience that lowers the learning curve for new users.

- **Enhanced Scalability**: As Agent Shepherd evolves, additional configuration types (e.g., environment-specific configs, user profiles, or integration settings) can be added to config/ without cluttering the root directory. This supports future growth while maintaining clean separation.

### Trade-offs
1. **Import Path Complexity**: Dynamic path resolution needed vs. simple relative imports
   - Decision: Implement path resolution utilities to maintain clean imports

2. **CLI Discovery**: Directory walking logic vs. hardcoded paths
   - Decision: Implement findAgentShepherdDir function for flexible discovery

3. **Build Process**: Change output location vs. keep current
   - Decision: Update build to output to .agent-shepherd/bin/ashep for consistency

4. **Development vs Production**: Same structure vs. separate
   - Decision: Use same structure, installation copies development repo

### Key Design Decisions
- Follow Git/VSCode pattern of hidden directories
- Keep development repo as source of truth
- Use dynamic path resolution for runtime flexibility
- Maintain backward compatibility where possible

### System Interactions
- Beads integration: Update path references
- OpenCode integration: Update CLI paths
- Build system: Modify output and scripts
- Installation: Change init process

### Validation Strategy
- Unit tests for path resolution
- Integration tests for CLI discovery
- E2E tests for full workflow
- Migration tests for existing installations