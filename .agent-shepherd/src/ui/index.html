<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agent Shepherd - Flow Visualization</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11.11.4/dist/umd/index.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/reactflow@11.11.4/dist/style.css">
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
                sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .react-flow {
            background: #f8fafc;
        }
        .policy-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        .phase-node {
            background: #6b7280;
            color: white;
            padding: 10px;
            border-radius: 8px;
            border: none;
            min-width: 120px;
            text-align: center;
        }
        .run-node {
            background: #3b82f6;
            color: white;
            padding: 8px;
            border-radius: 6px;
            border: none;
            min-width: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;
        const { createElement: el } = React;

        function AgentShepherdFlow() {
            const [policies, setPolicies] = useState([]);
            const [selectedPolicy, setSelectedPolicy] = useState('');
            const [phases, setPhases] = useState([]);
            const [runs, setRuns] = useState([]);
            const [loading, setLoading] = useState(true);
            const [nodes, setNodes] = useState([]);
            const [edges, setEdges] = useState([]);

            // Load policies on mount
            useEffect(() => {
                async function loadPolicies() {
                    try {
                        const policiesRes = await fetch('/api/policies');
                        const policiesData = await policiesRes.json();
                        setPolicies(policiesData);

                        const defaultPolicy = policiesData.find(p => p.isDefault);
                        if (defaultPolicy) {
                            setSelectedPolicy(defaultPolicy.id);
                        }
                    } catch (error) {
                        console.error('Error loading policies:', error);
                    }
                }
                loadPolicies();
            }, []);

            // Load data when policy changes
            useEffect(() => {
                if (!selectedPolicy) return;

                async function loadData() {
                    try {
                        setLoading(true);
                        const [phasesRes, runsRes] = await Promise.all([
                            fetch('/api/phases?policy=' + selectedPolicy),
                            fetch('/api/runs')
                        ]);

                        const phasesData = await phasesRes.json();
                        const runsData = await runsRes.json();

                        setPhases(phasesData);
                        setRuns(runsData);

                        // Create React Flow nodes and edges
                        const phaseNodes = phasesData.map((phase, index) => ({
                            id: 'phase-' + phase.id,
                            type: 'default',
                            position: { x: 150 + (index * 250), y: 100 },
                            data: { label: phase.name },
                            className: 'phase-node'
                        }));

                        const runNodes = runsData.map((run, index) => ({
                            id: run.id,
                            type: 'default',
                            position: { x: 200 + (index * 250), y: 300 },
                            data: { label: run.agentId + ' - ' + run.phase },
                            className: 'run-node'
                        }));

                        const phaseEdges = [];
                        for (let i = 0; i < phasesData.length - 1; i++) {
                            phaseEdges.push({
                                id: 'edge-' + i,
                                source: 'phase-' + phasesData[i].id,
                                target: 'phase-' + phasesData[i + 1].id,
                                type: 'smoothstep'
                            });
                        }

                        const runEdges = runsData.map(run => ({
                            id: run.id + '-edge',
                            source: 'phase-' + run.phase,
                            target: run.id,
                            type: 'smoothstep'
                        }));

                        setNodes([...phaseNodes, ...runNodes]);
                        setEdges([...phaseEdges, ...runEdges]);

                    } catch (error) {
                        console.error('Error loading data:', error);
                    } finally {
                        setLoading(false);
                    }
                }

                loadData();
            }, [selectedPolicy]);

            if (loading) {
                return el('div', {
                    style: {
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        height: '100vh'
                    }
                }, 'Loading Agent Shepherd Flow...');
            }

            return el('div', { style: { width: '100vw', height: '100vh' } }, [
                el('div', {
                    className: 'policy-card',
                    style: {
                        position: 'absolute',
                        top: 10,
                        left: 10,
                        zIndex: 1000,
                        minWidth: '280px'
                    }
                }, [
                    el('h3', { style: { margin: '0 0 10px 0' } }, 'Agent Shepherd Flow'),
                    el('div', { style: { marginBottom: '10px' } }, [
                        el('label', {
                            style: { display: 'block', marginBottom: '5px', fontWeight: 'bold' }
                        }, 'Policy:'),
                        el('select', {
                            value: selectedPolicy,
                            onChange: (e) => setSelectedPolicy(e.target.value),
                            style: { width: '100%', padding: '6px', borderRadius: '4px', border: '1px solid #ccc' }
                        }, policies.map(p =>
                            el('option', { key: p.id, value: p.id },
                                p.name + (p.isDefault ? ' (Default)' : '')
                            )
                        ))
                    ]),
                    el('div', [
                        el('div', {}, 'Phases: ' + phases.length),
                        el('div', {}, 'Runs: ' + runs.length)
                    ])
                ]),
                el(ReactFlow, {
                    nodes: nodes,
                    edges: edges,
                    fitView: true,
                    style: { width: '100vw', height: '100vh' }
                }, [
                    el(ReactFlow.Background, {}),
                    el(ReactFlow.Controls, {}),
                    el(ReactFlow.MiniMap, {})
                ])
            ]);
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(el(AgentShepherdFlow));
    </script>
</body>
</html>