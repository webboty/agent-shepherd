{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentshepherd.dev/schemas/policies.json",
  "title": "Agent Shepherd Policies",
  "description": "Policy definitions for workflow phases and transition rules",
  "type": "object",
  "required": ["policies"],
  "properties": {
    "policies": {
      "type": "object",
      "description": "Map of policy definitions",
      "patternProperties": {
        "^[a-zA-Z][a-zA-Z0-9_-]*$": {
          "$ref": "#/definitions/policyConfig"
        }
      },
      "additionalProperties": false
    },
    "default_policy": {
      "type": "string",
      "pattern": "^[a-zA-Z][a-zA-Z0-9_-]*$",
      "description": "Name of the default policy to use"
    }
  },
  "additionalProperties": false,
  "definitions": {
    "policyConfig": {
      "type": "object",
      "required": ["name", "phases"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Human-readable policy name"
        },
        "description": {
          "type": "string",
          "description": "Policy description"
        },
        "issue_types": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_-]*$"
          },
          "description": "Array of issue types that trigger this policy (e.g., ['bug', 'feature'])"
        },
        "priority": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "default": 50,
          "description": "Priority for policy selection (higher = more preferred, used for tie-breaking)"
        },
        "phases": {
          "type": "array",
          "minItems": 1,
          "items": {
            "$ref": "#/definitions/phaseConfig"
          },
          "description": "Workflow phases in order"
        },
        "retry": {
          "$ref": "#/definitions/retryConfig",
          "description": "Retry configuration"
        },
        "timeout_base_ms": {
          "type": "integer",
          "minimum": 60000,
          "maximum": 3600000,
          "default": 300000,
          "description": "Base timeout for phases in milliseconds"
        },
        "stall_threshold_ms": {
          "type": "integer",
          "minimum": 10000,
          "maximum": 300000,
          "default": 60000,
          "description": "Time threshold to detect stalled runs"
        },
        "require_hitl": {
          "type": "boolean",
          "default": false,
          "description": "Whether human-in-the-loop approval is required"
        },
        "fallback_enabled": {
          "type": "boolean",
          "description": "Whether fallback is enabled for this policy. Inherits from global if not set."
        },
        "fallback_agent": {
          "type": "string",
          "description": "Fallback agent ID for this policy. Inherits from global if not set."
        },
        "fallback_mappings": {
          "type": "object",
          "description": "Capability-specific fallback mappings for this policy",
          "additionalProperties": {
            "type": "string"
          }
        }
      },
      "additionalProperties": false
    },
    "phaseConfig": {
      "type": "object",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Phase name"
        },
        "description": {
          "type": "string",
          "description": "Phase description"
        },
        "capabilities": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^[a-z][a-z0-9_-]*$"
          },
          "description": "Required agent capabilities for this phase"
        },
        "timeout_multiplier": {
          "type": "number",
          "minimum": 0.5,
          "maximum": 5.0,
          "default": 1.0,
          "description": "Multiplier for base timeout"
        },
        "require_approval": {
          "type": "boolean",
          "default": false,
          "description": "Whether this phase requires explicit approval"
        },
        "fallback_agent": {
          "type": "string",
          "description": "Fallback agent ID override for this phase"
        },
        "fallback_enabled": {
          "type": "boolean",
          "description": "Whether fallback is enabled for this phase. Overrides policy and global settings."
        },
        "max_visits": {
          "type": "integer",
          "minimum": 1,
          "maximum": 100,
          "description": "Maximum number of times this phase can be visited before being blocked by loop prevention. Overrides global loop_prevention.max_visits_default."
        },
        "transitions": {
          "$ref": "#/definitions/TransitionBlock",
          "description": "Optional transition configuration for complex routing"
        }
      },
      "additionalProperties": false
    },
    "retryConfig": {
      "type": "object",
      "required": ["max_attempts", "backoff_strategy"],
      "properties": {
        "max_attempts": {
          "type": "integer",
          "minimum": 1,
          "maximum": 10,
          "default": 3,
          "description": "Maximum number of retry attempts"
        },
        "backoff_strategy": {
          "type": "string",
          "enum": ["exponential", "linear", "fixed"],
          "default": "exponential",
          "description": "Backoff strategy for retries"
        },
        "initial_delay_ms": {
          "type": "integer",
          "minimum": 1000,
          "maximum": 60000,
          "default": 5000,
          "description": "Initial delay for backoff"
        },
        "max_delay_ms": {
          "type": "integer",
          "minimum": 30000,
          "maximum": 600000,
          "default": 300000,
          "description": "Maximum delay for backoff"
        }
      },
      "additionalProperties": false
    },
    "TransitionConfig": {
      "type": "object",
      "required": ["capability", "prompt", "allowed_destinations"],
      "properties": {
        "capability": {
          "type": "string",
          "description": "Decision agent capability (e.g., 'test-decision')"
        },
        "prompt": {
          "type": "string",
          "description": "Decision instructions for the agent"
        },
        "allowed_destinations": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "minItems": 1,
          "description": "Safety constraint - valid phases to jump to"
        },
        "messaging": {
          "type": "boolean",
          "default": false,
          "description": "Enable phase messenger for complex data exchange"
        },
        "confidence_thresholds": {
          "type": "object",
          "properties": {
            "auto_advance": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "description": "High confidence threshold for auto progression"
            },
            "require_approval": {
              "type": "number",
              "minimum": 0.0,
              "maximum": 1.0,
              "description": "Medium confidence threshold triggering review"
            }
          },
          "additionalProperties": false,
          "description": "Confidence thresholds for automatic vs manual routing"
        }
      },
      "additionalProperties": false,
      "description": "Configuration for AI-based conditional routing"
    },
    "TransitionBlock": {
      "type": "object",
      "properties": {
        "on_success": {
          "oneOf": [
            {
              "type": "string",
              "description": "Direct jump to phase name"
            },
            {
              "$ref": "#/definitions/TransitionConfig"
            }
          ],
          "description": "Transition on success - can be direct jump or AI decision"
        },
        "on_failure": {
          "oneOf": [
            {
              "type": "string",
              "description": "Direct jump to phase name"
            },
            {
              "$ref": "#/definitions/TransitionConfig"
            }
          ],
          "description": "Transition on failure - can be direct jump or AI decision"
        },
        "on_partial_success": {
          "$ref": "#/definitions/TransitionConfig",
          "description": "Transition on partial success - AI decision only (not string)"
        },
        "on_unclear": {
          "$ref": "#/definitions/TransitionConfig",
          "description": "Transition on unclear outcome - AI decision only (not string)"
        }
      },
      "additionalProperties": false,
      "description": "Optional transition configuration for phases"
    }
  },
  "examples": [
    {
      "policies": {
        "default": {
          "name": "Default Workflow",
          "description": "Standard development workflow",
          "issue_types": ["bug", "feature", "task"],
          "priority": 50,
          "phases": [
            {
              "name": "plan",
              "description": "Planning and design phase",
              "capabilities": ["planning", "architecture"],
              "timeout_multiplier": 1.0
            },
            {
              "name": "implement",
              "description": "Implementation phase",
              "capabilities": ["coding", "refactoring"],
              "timeout_multiplier": 2.0
            },
            {
              "name": "test",
              "description": "Testing phase",
              "capabilities": ["testing", "qa"],
              "timeout_multiplier": 1.5
            },
            {
              "name": "review",
              "description": "Code review phase",
              "capabilities": ["review", "documentation"],
              "require_approval": true,
              "fallback_agent": "summary"
            }
          ],
          "retry": {
            "max_attempts": 3,
            "backoff_strategy": "exponential",
            "initial_delay_ms": 5000,
            "max_delay_ms": 300000
          },
          "timeout_base_ms": 300000,
          "stall_threshold_ms": 60000,
          "require_hitl": false,
          "fallback_enabled": true,
          "fallback_agent": "build",
          "fallback_mappings": {
            "review": "summary",
            "architecture": "plan"
          }
        }
      },
      "default_policy": "default"
    }
  ]
}