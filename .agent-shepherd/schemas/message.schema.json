{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "message.schema.json",
  "title": "Phase Messenger Schema",
  "description": "Schema for phase messenger messages, queries, and statistics",
  "type": "object",
  "oneOf": [
    {
      "$ref": "#/definitions/phaseMessage"
    },
    {
      "$ref": "#/definitions/createMessageInput"
    },
    {
      "$ref": "#/definitions/messageQuery"
    }
  ],
  "definitions": {
    "phaseMessage": {
      "type": "object",
      "description": "A message passed between phases in a workflow",
      "required": ["id", "issue_id", "from_phase", "to_phase", "run_counter", "message_type", "content", "read", "created_at"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^msg-\\d+-[a-z0-9]+$",
          "description": "Unique message identifier"
        },
        "issue_id": {
          "type": "string",
          "description": "ID of the associated issue"
        },
        "from_phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Phase that sent the message"
        },
        "to_phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Phase that should receive the message"
        },
        "run_counter": {
          "type": "integer",
          "minimum": 1,
          "description": "Run iteration number"
        },
        "message_type": {
          "type": "string",
          "enum": ["context", "result", "decision", "data"],
          "description": "Type of message content"
        },
        "content": {
          "type": "string",
          "minLength": 1,
          "description": "Message content"
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata as key-value pairs",
          "additionalProperties": true
        },
        "read": {
          "type": "boolean",
          "description": "Whether message has been read by recipient"
        },
        "created_at": {
          "type": "integer",
          "minimum": 0,
          "description": "Unix timestamp in milliseconds when message was created"
        },
        "read_at": {
          "oneOf": [
            { "type": "integer", "minimum": 0 },
            { "type": "null" }
          ],
          "description": "Unix timestamp in milliseconds when message was read, or null if unread"
        }
      },
      "additionalProperties": false
    },
    "createMessageInput": {
      "type": "object",
      "description": "Input data for creating a new message",
      "required": ["issue_id", "from_phase", "to_phase", "message_type", "content"],
      "properties": {
        "issue_id": {
          "type": "string",
          "description": "ID of the associated issue"
        },
        "from_phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Phase that is sending the message"
        },
        "to_phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Phase that should receive the message"
        },
        "message_type": {
          "type": "string",
          "enum": ["context", "result", "decision", "data"],
          "description": "Type of message content"
        },
        "content": {
          "type": "string",
          "minLength": 1,
          "description": "Message content"
        },
        "run_counter": {
          "type": "integer",
          "minimum": 1,
          "default": 1,
          "description": "Run iteration number (defaults to 1)"
        },
        "metadata": {
          "type": "object",
          "description": "Optional metadata as key-value pairs",
          "additionalProperties": true
        }
      },
      "additionalProperties": false
    },
    "messageQuery": {
      "type": "object",
      "description": "Query parameters for filtering messages",
      "properties": {
        "issue_id": {
          "type": "string",
          "description": "Filter by issue ID"
        },
        "from_phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Filter by sender phase"
        },
        "to_phase": {
          "type": "string",
          "pattern": "^[a-z][a-z0-9_-]*$",
          "description": "Filter by recipient phase"
        },
        "message_type": {
          "type": "string",
          "enum": ["context", "result", "decision", "data"],
          "description": "Filter by message type"
        },
        "read": {
          "type": "boolean",
          "description": "Filter by read status (true = read, false = unread)"
        },
        "run_counter": {
          "type": "integer",
          "minimum": 1,
          "description": "Filter by run counter"
        },
        "limit": {
          "type": "integer",
          "minimum": 1,
          "maximum": 1000,
          "description": "Maximum number of messages to return"
        }
      },
      "additionalProperties": false
    },
    "messageStats": {
      "type": "object",
      "description": "Statistics about messages",
      "required": ["total_messages", "unread_messages", "read_messages", "db_size_mb"],
      "properties": {
        "total_messages": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of messages"
        },
        "unread_messages": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of unread messages"
        },
        "read_messages": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of read messages"
        },
        "by_issue": {
          "type": "object",
          "patternProperties": {
            "^[a-zA-Z0-9_-]+$": { "type": "integer", "minimum": 0 }
          },
          "additionalProperties": false,
          "description": "Message count per issue ID"
        },
        "db_size_mb": {
          "type": "number",
          "minimum": 0,
          "description": "Database size in megabytes"
        }
      },
      "additionalProperties": false
    },
    "phaseMessengerConfig": {
      "type": "object",
      "description": "Configuration for phase messenger",
      "required": ["size_limits", "cleanup", "storage"],
      "properties": {
        "size_limits": {
          "type": "object",
          "description": "Size limits for message content and metadata",
          "required": ["max_content_length", "max_metadata_length", "max_messages_per_issue_phase", "max_messages_per_issue"],
          "properties": {
            "max_content_length": {
              "type": "integer",
              "minimum": 100,
              "default": 10000,
              "description": "Maximum message content length in characters"
            },
            "max_metadata_length": {
              "type": "integer",
              "minimum": 100,
              "default": 5000,
              "description": "Maximum metadata size in characters (JSON string)"
            },
            "max_messages_per_issue_phase": {
              "type": "integer",
              "minimum": 1,
              "default": 100,
              "description": "Maximum messages per issue-phase combination"
            },
            "max_messages_per_issue": {
              "type": "integer",
              "minimum": 1,
              "default": 500,
              "description": "Maximum total messages per issue"
            }
          },
          "additionalProperties": false
        },
        "cleanup": {
          "type": "object",
          "description": "Cleanup configuration",
          "required": ["default_max_age_days", "keep_last_n_per_phase", "keep_last_n_runs"],
          "properties": {
            "default_max_age_days": {
              "type": "integer",
              "minimum": 1,
              "default": 90,
              "description": "Age (in days) after which old read messages can be deleted"
            },
            "keep_last_n_per_phase": {
              "type": "integer",
              "minimum": 0,
              "default": 10,
              "description": "Number of recent messages to keep when cleaning up read messages per phase"
            },
            "keep_last_n_runs": {
              "type": "integer",
              "minimum": 0,
              "default": 1,
              "description": "Number of recent run iterations to keep when cleaning up old runs"
            }
          },
          "additionalProperties": false
        },
        "storage": {
          "type": "object",
          "description": "Storage configuration",
          "required": ["data_dir", "database_file", "jsonl_file"],
          "properties": {
            "data_dir": {
              "type": "string",
              "default": ".agent-shepherd",
              "description": "Data directory for message storage (relative to project root)"
            },
            "database_file": {
              "type": "string",
              "default": "messages.db",
              "description": "Database filename"
            },
            "jsonl_file": {
              "type": "string",
              "default": "messages.jsonl",
              "description": "JSONL audit trail filename"
            }
          },
          "additionalProperties": false
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "id": "msg-1704067200000-abc123def",
      "issue_id": "issue-123",
      "from_phase": "plan",
      "to_phase": "implement",
      "run_counter": 1,
      "message_type": "context",
      "content": "Architecture decisions: Use REST API, PostgreSQL, and React frontend",
      "metadata": {
        "priority": "high",
        "related_issues": ["issue-124", "issue-125"]
      },
      "read": false,
      "created_at": 1704067200000,
      "read_at": null
    },
    {
      "issue_id": "issue-123",
      "from_phase": "implement",
      "to_phase": "test",
      "message_type": "result",
      "content": "Implementation completed. Features: login, registration, profile.",
      "run_counter": 2,
      "metadata": {
        "files_changed": 15,
        "tests_written": 30
      }
    },
    {
      "issue_id": "issue-123",
      "to_phase": "test",
      "read": false,
      "limit": 10
    },
    {
      "total_messages": 150,
      "unread_messages": 25,
      "read_messages": 125,
      "by_issue": {
        "issue-123": 50,
        "issue-124": 45,
        "issue-125": 55
      },
      "db_size_mb": 2.5
    },
    {
      "size_limits": {
        "max_content_length": 10000,
        "max_metadata_length": 5000,
        "max_messages_per_issue_phase": 100,
        "max_messages_per_issue": 500
      },
      "cleanup": {
        "default_max_age_days": 90,
        "keep_last_n_per_phase": 10,
        "keep_last_n_runs": 1
      },
      "storage": {
        "data_dir": ".agent-shepherd",
        "database_file": "messages.db",
        "jsonl_file": "messages.jsonl"
      }
    }
  ]
}
