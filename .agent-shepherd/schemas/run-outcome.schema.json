{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://agentshepherd.dev/schemas/run-outcome.json",
  "title": "Agent Run Outcome",
  "description": "Outcome and status of an agent execution run",
  "type": "object",
  "required": ["id", "issue_id", "agent_id", "phase", "status", "start_time"],
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^run-[a-zA-Z0-9_-]+$",
      "description": "Unique run identifier"
    },
    "issue_id": {
      "type": "string",
      "description": "ID of the issue being processed"
    },
    "agent_id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9_-]*$",
      "description": "ID of the agent that ran"
    },
    "phase": {
      "type": "string",
      "description": "Workflow phase this run belongs to"
    },
    "status": {
      "type": "string",
      "enum": ["pending", "running", "completed", "failed", "cancelled", "stalled"],
      "description": "Current status of the run"
    },
    "start_time": {
      "type": "string",
      "format": "date-time",
      "description": "When the run started"
    },
    "end_time": {
      "type": "string",
      "format": "date-time",
      "description": "When the run ended (null for ongoing runs)"
    },
    "duration_ms": {
      "type": "integer",
      "minimum": 0,
      "description": "Duration of the run in milliseconds (calculated from start/end times)"
    },
    "session_id": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_-]+$",
      "description": "OpenCode session identifier"
    },
    "outcome": {
      "oneOf": [
        {
          "$ref": "#/definitions/successOutcome"
        },
        {
          "$ref": "#/definitions/failureOutcome"
        },
        {
          "$ref": "#/definitions/cancelledOutcome"
        }
      ]
    },
    "artifacts": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/artifact"
      },
      "description": "Artifacts created, modified, or deleted during the run"
    },
    "error_details": {
      "$ref": "#/definitions/errorDetails",
      "description": "Structured error information"
    },
    "warnings": {
      "type": "array",
      "items": {
        "type": "string"
      },
      "description": "Non-blocking issues or informational messages"
    },
    "tool_calls": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/toolCall"
      },
      "description": "Tool calls made during execution"
    },
    "metadata": {
      "type": "object",
      "properties": {
        "attempt_number": {
          "type": "integer",
          "minimum": 1,
          "description": "Which attempt this is (for retries)"
        },
        "retry_of": {
          "type": "string",
          "pattern": "^run-[a-zA-Z0-9_-]+$",
          "description": "ID of the run being retried"
        },
        "hitl_required": {
          "type": "boolean",
          "description": "Whether human-in-the-loop was required"
        },
        "hitl_provided": {
          "type": "boolean",
          "description": "Whether human-in-the-loop was provided"
        },
        "timeout_extension": {
          "type": "integer",
          "minimum": 0,
          "description": "Additional time granted in milliseconds"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "definitions": {
    "successOutcome": {
      "type": "object",
      "required": ["type", "result"],
      "properties": {
        "type": {
          "const": "success"
        },
        "result": {
          "type": "string",
          "description": "Description of successful outcome"
        },
        "next_phase": {
          "type": "string",
          "description": "Next phase to transition to"
        },
        "artifacts": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/artifact"
          },
          "description": "Artifacts created by the run"
        },
        "metrics": {
          "$ref": "#/definitions/metrics",
          "description": "Performance metrics"
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Non-blocking issues or informational messages"
        },
        "tool_calls": {
          "type": "array",
          "items": {
            "$ref": "#/definitions/toolCall"
          },
          "description": "Tool calls made during execution"
        }
      },
      "additionalProperties": false
    },
    "failureOutcome": {
      "type": "object",
      "required": ["type", "error"],
      "properties": {
        "type": {
          "const": "failure"
        },
        "error": {
          "type": "string",
          "description": "Error description"
        },
        "error_code": {
          "type": "string",
          "pattern": "^[A-Z][A-Z0-9_]*$",
          "description": "Machine-readable error code"
        },
        "error_details": {
          "$ref": "#/definitions/errorDetails",
          "description": "Structured error information"
        },
        "retryable": {
          "type": "boolean",
          "default": true,
          "description": "Whether this failure can be retried"
        },
        "suggested_action": {
          "type": "string",
          "description": "Suggested action to resolve the failure"
        },
        "context": {
          "type": "object",
          "description": "Additional error context"
        },
        "warnings": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Non-blocking issues or informational messages"
        }
      },
      "additionalProperties": false
    },
    "cancelledOutcome": {
      "type": "object",
      "required": ["type", "reason"],
      "properties": {
        "type": {
          "const": "cancelled"
        },
        "reason": {
          "type": "string",
          "description": "Reason for cancellation"
        },
        "cancelled_by": {
          "type": "string",
          "enum": ["user", "system", "timeout"],
          "description": "Who cancelled the run"
        }
      },
      "additionalProperties": false
    },
    "artifact": {
      "type": "object",
      "required": ["path", "operation"],
      "properties": {
        "path": {
          "type": "string",
          "description": "Path to the artifact"
        },
        "operation": {
          "type": "string",
          "enum": ["created", "modified", "deleted"],
          "description": "Operation performed on the artifact"
        },
        "size": {
          "type": "integer",
          "minimum": 0,
          "description": "Size in bytes (if applicable)"
        },
        "type": {
          "type": "string",
          "enum": ["file", "directory"],
          "description": "Type of artifact"
        }
      },
      "additionalProperties": false
    },
    "errorDetails": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "description": "Error type (e.g., \"TimeoutError\", \"ValidationError\")"
        },
        "message": {
          "type": "string",
          "description": "Error message"
        },
        "stack_trace": {
          "type": "string",
          "description": "Full stack trace"
        },
        "file_path": {
          "type": "string",
          "description": "File where error occurred"
        },
        "line_number": {
          "type": "integer",
          "minimum": 0,
          "description": "Line number of error"
        }
      },
      "additionalProperties": false
    },
    "toolCall": {
      "type": "object",
      "required": ["name", "inputs", "status"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Tool name"
        },
        "inputs": {
          "description": "Tool inputs",
          "type": "object"
        },
        "outputs": {
          "type": "string",
          "description": "Tool outputs"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Tool execution time in milliseconds"
        },
        "status": {
          "type": "string",
          "enum": ["completed", "error", "cancelled"],
          "description": "Tool call status"
        }
      },
      "additionalProperties": false
    },
    "metrics": {
      "type": "object",
      "properties": {
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Duration of the run in milliseconds"
        },
        "tokens_used": {
          "type": "integer",
          "minimum": 0,
          "description": "Total tokens consumed"
        },
        "cost": {
          "type": "number",
          "minimum": 0,
          "description": "Cost in dollars"
        },
        "start_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "When agent started execution (epoch ms)"
        },
        "end_time_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "When agent finished execution (epoch ms)"
        },
        "api_calls_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of API calls made"
        },
        "model_name": {
          "type": "string",
          "description": "Model actually used (provider/model format)"
        }
      },
      "additionalProperties": false
    }
  },
  "examples": [
    {
      "id": "run-abc123",
      "issue_id": "agent-shepherd-001",
      "agent_id": "default-coder",
      "phase": "implementation",
      "status": "completed",
      "start_time": "2025-12-20T10:00:00Z",
      "end_time": "2025-12-20T10:45:23Z",
      "duration_ms": 2723000,
      "session_id": "session-def456",
      "outcome": {
        "type": "success",
        "result": "Successfully implemented core modules",
        "next_phase": "test",
        "artifacts": [
          {
            "operation": "created",
            "path": "src/core/worker-engine.ts",
            "type": "file"
          },
          {
            "operation": "modified",
            "path": "src/core/logging.ts",
            "size": 2500,
            "type": "file"
          }
        ],
        "metrics": {
          "duration_ms": 2723000,
          "tokens_used": 15420,
          "cost": 0.12,
          "start_time_ms": 1734670800000,
          "end_time_ms": 1734673523000,
          "api_calls_count": 8,
          "model_name": "anthropic/claude-sonnet"
        },
        "tool_calls": [
          {
            "name": "bash",
            "inputs": {
              "command": "npm test"
            },
            "outputs": "Test output...",
            "duration_ms": 5000,
            "status": "completed"
          },
          {
            "name": "write",
            "inputs": {
              "content": "file content...",
              "path": "src/test.ts"
            },
            "duration_ms": 100,
            "status": "completed"
          }
        ],
        "warnings": [
          "Lint warning: unused variable"
        ]
      },
      "metadata": {
        "attempt_number": 1,
        "hitl_required": false
      }
    }
  ]
}